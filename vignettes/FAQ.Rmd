---
title: "Frequently asked questions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Frequently asked questions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Under construction

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ggtrace)
```

## What can you `ggtrace()`?

### ggproto methods

```{r}
library(ggplot2)
```

Plots not printed to save space

```{r, fig.show='hide'}
ggtrace(StatBoxplot$compute_group, -1, verbose = FALSE)

ggplot(mpg, aes(drv, hwy)) +
  geom_boxplot()

last_ggtrace()
```

```{r fig.show='hide'}
global_ggtrace_state()
global_ggtrace_state(TRUE)
clear_global_ggtrace()

ggtrace(StatBoxplot$compute_group, -1, once = FALSE, verbose = FALSE)

boxplot_plot <- ggplot(mpg, aes(drv, hwy)) +
  geom_boxplot()
boxplot_plot

global_ggtrace_state(FALSE)
gguntrace(StatBoxplot$compute_group)

global_ggtrace()
```

### S3/S4 generics

The exported generic `ggplot_build()` is itself not meaningful but the unexported method for <ggplot> class `ggplot_build.ggplot()` contains the actual data transformation pipeline. 

```{r}
body(ggplot_build)

attr(utils::methods("ggplot_build"), "info")
```

You can trace the `ggplot_build()` method defined for <ggplot> in the same way

```{r}
ggtrace(ggplot2:::ggplot_build.ggplot, -1, verbose = FALSE)

boxplot_plot

last_ggtrace()[[1]]$data[[1]]

identical(last_ggtrace()[[1]]$data[[1]], layer_data(boxplot_plot, 1))
```


### functions

### R6 methods

```{r}
gen_counter <- function() {
  count <- 1
  list(
    increment = function() {
      count <<- count + 1
      count
    },
    get = function() { count }
  )
}
my_counter <- gen_counter()

my_counter$get()
my_counter$increment()
my_counter$increment()

ggtrace(my_counter$increment, -1)
```


- ggproto methods
- functions
- S3/S4 generics
- R6, etc.

## Is ggtrace() safe?

- Cleans up after itself (`once = TRUE` by default)
- Doesn't rely on side effects - but be careful about assignment (ex: replacing `ggproto$method <- ...` will change the ggproto obj - but thats just a general referencing thing not something unique to ggtrace)
- Traced method masks the original and doesn't override it (original stored in `attr(..., "original")` of traced function)
- Built-in safety measures (ex: always untraces before tracing which prevents nested traces from being created, all pkg functions give ample warning about whether things are already being traced, doesn't let you trace functions that aren't bound to a variable, etc.)
