<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Overview • ggtrace</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Atkinson_Hyperlegible-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Overview">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ggtrace</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://yjunechoe.github.io/static/papers/Choe_2022_SublayerGG.pdf">Paper</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Usage</h6></li>
    <li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/overview.html">Overview</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Miscellaneous</h6></li>
    <li><a class="dropdown-item" href="../articles/FAQ.html">Frequently asked questions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/yjunechoe/ggtrace/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Overview</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/yjunechoe/ggtrace/blob/HEAD/vignettes/overview.Rmd" class="external-link"><code>vignettes/overview.Rmd</code></a></small>
      <div class="d-none name"><code>overview.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="extending-basetrace-with-ggtrace">
<strong>Extending <code>base::trace()</code> with
<code>ggtrace()</code></strong><a class="anchor" aria-label="anchor" href="#extending-basetrace-with-ggtrace"></a>
</h2>
<p>The low-level function <code><a href="../reference/ggtrace.html">ggtrace()</a></code> is designed for
interacting with functions and ggproto methods in the
<a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a> ecosystem, from the “outside”.</p>
<p>Formally put, <code><a href="../reference/ggtrace.html">ggtrace()</a></code> allows the user to inject
arbitrary expressions (called <strong>traces</strong>) to functions and
methods that are evaluated over the execution of a ggplot. When
“triggered” by the evaluation of the ggplot, these traces may modify the
resulting graphical output, or they may simply log their values to the
“tracedump” for further inspection by the user. Check out the <a href="https://yjunechoe.github.io/ggtrace/articles/FAQ.html">FAQ
vignette</a> for more details.</p>
<p>Briefly, there are three key arguments to <code><a href="../reference/ggtrace.html">ggtrace()</a></code>:</p>
<ul>
<li>
<code>method</code>: what function/method to trace</li>
<li>
<code>trace_steps</code>: where in the body to inject
expressions</li>
<li>
<code>trace_exprs</code> what expressions to inject</li>
</ul>
<p>A simple example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dummy_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">y</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">dummy_fn</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3</span></span></code></pre>
<p>The following code injects the code <code>z &lt;- z * 10</code> right
as <code>dummy_fn</code> enters the third “step” in the body, <em>right
before</em> the line <code>return(z)</code> is ran.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/body.html" class="external-link">body</a></span><span class="op">(</span><span class="va">dummy_fn</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## return(z)</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ggtrace.html">ggtrace</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="va">dummy_fn</span>,</span>
<span>  trace_steps <span class="op">=</span> <span class="fl">3L</span>, <span class="co"># Before `return(z)` is ran</span></span>
<span>  trace_exprs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">z</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `dummy_fn` now being traced.</span></span></code></pre>
<p>Note that the value of <code>trace_exprs</code> must be of type
“language” (a quoted expression), the idea being that we are
<em>injecting</em> code to be evaluate inside the function when it is
called. Often, providing the code wrapped in <code><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote()</a></code>
suffices. For more complex injections see the <a href="https://adv-r.hadley.nz/expressions.html" class="external-link">Expressions chapter of
Advanced R</a></p>
<p>After this <code><a href="../reference/ggtrace.html">ggtrace()</a></code> call, the next time
<code>dummy_fn</code> is called it is run with this injected code.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Returns 30 instead of 3</span></span>
<span><span class="fu">dummy_fn</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Triggering trace on `dummy_fn`</span></span></code></pre>
<pre><code><span><span class="co">## Untracing `dummy_fn` on exit.</span></span></code></pre>
<pre><code><span><span class="co">## [1] 30</span></span></code></pre>
<p>Essentially, <code>dummy_fn</code> ran with this following modified
code just now:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dummy_fn_traced</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">y</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="va">z</span> <span class="op">*</span> <span class="fl">10</span> <span class="co">#&lt; injected code!</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">dummy_fn_traced</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 30</span></span></code></pre>
<p>By default, traces created by <a href="https://yjunechoe.github.io/ggtrace">ggtrace</a> functions delete
themselves after being triggered. You can also check whether a function
is currently being traced with <code><a href="../reference/is_traced.html">is_traced()</a></code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is_traced.html">is_traced</a></span><span class="op">(</span><span class="va">dummy_fn</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<p><a href="https://yjunechoe.github.io/ggtrace">ggtrace</a> automatically logs the output of triggered
trace to what we call <strong>tracedumps</strong>. For example,
<code><a href="../reference/last_ggtrace.html">last_ggtrace()</a></code> stores the output of the <em>last</em> trace
created by <code><a href="../reference/ggtrace.html">ggtrace()</a></code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The value of `(z &lt;- z * 10)` when it was ran</span></span>
<span><span class="fu"><a href="../reference/last_ggtrace.html">last_ggtrace</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Note that this is a list of length `trace_steps`</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] 30</span></span></code></pre>
<p>See the references section <a href="https://yjunechoe.github.io/ggtrace/reference/index.html#extending-base-trace-"><strong>Extending
base::trace()</strong></a> for more functionalities offered by
<code><a href="../reference/ggtrace.html">ggtrace()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="workflows-for-interacting-with-ggplot-internals">
<strong>Workflows for interacting with ggplot
internals</strong><a class="anchor" aria-label="anchor" href="#workflows-for-interacting-with-ggplot-internals"></a>
</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span> <span class="co"># v3.3.5</span></span></code></pre></div>
<p>Admittedly, <code><a href="../reference/ggtrace.html">ggtrace()</a></code> is a bit too clunky for
interactive explorations of ggplot internals. To address this, we offer
“workflow” functions in the form of
<code>ggtrace_{action}_{value}()</code>. These are grouped into three
workflows: Inspect, Capture, and Highjack.</p>
<p><strong>NOTE</strong>: Making the most out of these workflow
functions requires a hint of knowledge about ggplot internals, namely
the fact that <strong>ggproto objects</strong> like <a href="https://ggplot2.tidyverse.org/reference/ggplot2-ggproto.html#stats" class="external-link">Stat</a>
and <a href="https://ggplot2.tidyverse.org/reference/ggplot2-ggproto.html#geoms" class="external-link">Geom</a>
exists, and that these <a href="https://ggplot2-book.org/spring1.html#methods" class="external-link">ggprotos have
methods</a> that step in at different parts of the ggplot build/render
pipeline to modify the data. If you are completely new to these
concepts, you should at least watch <a href="https://twitter.com/thomasp85" class="external-link">Thomas Lin Pedersen</a>’s talk on
<a href="https://www.rstudio.com/resources/rstudioconf-2020/extending-your-ability-to-extend-ggplot2/" class="external-link">Extending
your ability to extend ggplot2</a> before proceeding.</p>
<div class="section level3">
<h3 id="walkthrough-with-geom_smooth">
<strong>Walkthrough with <code>geom_smooth()</code></strong><a class="anchor" aria-label="anchor" href="#walkthrough-with-geom_smooth"></a>
</h3>
<p>Say we want to learn more about how <code><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth()</a></code> layer
works, exactly</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## geom_smooth: na.rm = FALSE, orientation = NA, se = TRUE</span></span>
<span><span class="co">## stat_smooth: na.rm = FALSE, orientation = NA, se = TRUE</span></span>
<span><span class="co">## position_identity</span></span></code></pre>
<p>To do this, we’re going to adopt the example from the <a href="https://ggplot2-book.org/internals.html" class="external-link">ggplot2 internals chapter
of the ggplot book</a></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">displ</span>, <span class="va">hwy</span>, color <span class="op">=</span> <span class="va">drv</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitter.html" class="external-link">position_jitter</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1116</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"A plot for expository purposes"</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-10-1.png" width="1093.75"></p>
<p>Let’s focus on the Stat ggproto. We see that
<code><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth()</a></code> uses the <code>StatSmooth</code> ggproto</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">stat</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "StatSmooth" "Stat"       "ggproto"    "gg"</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">StatSmooth</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">stat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>The bulk of the work by a Stat is done in the <code>compute_*</code>
family of methods, which are essentially just functions. We’ll focus on
<code>compute_group</code> here:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ggproto methods wrap over the actual function and print extra info</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "ggproto_method"</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use `get_method` to pull out just the function component</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span> <span class="fu"><a href="../reference/get_method.html">get_method</a></span><span class="op">(</span><span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "function"</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># StatSmooth inherits `compute_layer`/`compute_panel` and defines `compute_group`</span></span>
<span><span class="fu"><a href="../reference/get_method.html">get_method_inheritance</a></span><span class="op">(</span><span class="va">StatSmooth</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $Stat</span></span>
<span><span class="co">##  [1] "aesthetics"      "compute_layer"   "compute_panel"   "default_aes"    </span></span>
<span><span class="co">##  [5] "finish_layer"    "non_missing_aes" "optional_aes"    "parameters"     </span></span>
<span><span class="co">##  [9] "retransform"     "setup_data"     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $StatSmooth</span></span>
<span><span class="co">## [1] "compute_group" "dropped_aes"   "extra_params"  "required_aes" </span></span>
<span><span class="co">## [5] "setup_params"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="inspect">
<strong>Inspect</strong><a class="anchor" aria-label="anchor" href="#inspect"></a>
</h3>
<p>Here we introduce our first workflow function
<code><a href="../reference/ggtrace_inspect_n.html">ggtrace_inspect_n()</a></code>, which takes a ggplot as the first
argument and a ggproto method as the second argument, returning the
number of times the ggproto method has been called in the ggplot’s
evaluation:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ggtrace_inspect_n.html">ggtrace_inspect_n</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, method <span class="op">=</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 6</span></span></code></pre>
<p>As we might have guessed, <code>StatSmooth$compute_group</code> is
called for each fitted line (each group) in the plot. But if
<code>StatSmooth$compute_group</code> is essentially a function, what
does it return?</p>
<p>We can answer that with another workflow function
<code><a href="../reference/ggtrace_inspect_return.html">ggtrace_inspect_return()</a></code>, which shares a similar
syntax:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">return_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ggtrace_inspect_return.html">ggtrace_inspect_return</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, method <span class="op">=</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">return_val</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 80  6</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">return_val</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          x        y     ymin     ymax        se flipped_aes</span></span>
<span><span class="co">## 1 1.800000 24.33592 23.07845 25.59339 0.6250675       FALSE</span></span>
<span><span class="co">## 2 1.859494 24.17860 22.94830 25.40890 0.6115600       FALSE</span></span>
<span><span class="co">## 3 1.918987 24.02127 22.81795 25.22460 0.5981528       FALSE</span></span>
<span><span class="co">## 4 1.978481 23.86395 22.68738 25.04052 0.5848527       FALSE</span></span>
<span><span class="co">## 5 2.037975 23.70663 22.55658 24.85668 0.5716673       FALSE</span></span>
<span><span class="co">## 6 2.097468 23.54931 22.42554 24.67307 0.5586045       FALSE</span></span></code></pre>
<p>Note that <code><a href="../reference/ggtrace_inspect_return.html">ggtrace_inspect_return()</a></code> only gave us 1
dataframe, corresponding to the return value of
<code>StatSmooth$compute_group</code> the <em>first time</em> it was
called. This comes from the default value of the third argument
<code>cond</code> being set to <code>quote(._counter_ == 1)</code>.</p>
<p>Here, <code>._counter_</code> is an internal variable that keeps
track of how many times the method has been called. It’s available for
all workflow functions and you can read more in the <a href="https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_return.html#tracing-context"><strong>Tracing
context</strong></a> section of the docs.</p>
<p>If we instead wanted to get the return value of
<code>StatSmooth$compute_group</code> for the third group of the second
panel, for example, we can do so in one of two ways:</p>
<ol style="list-style-type: decimal">
<li>
<p>Set the value of <code>cond</code> to an expression that
evaluates to true for that panel and group:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">return_val_2_3_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ggtrace_inspect_return.html">ggtrace_inspect_return</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">p</span>,</span>
<span>  method <span class="op">=</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span>,</span>
<span>  cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">PANEL</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;&amp;</span> <span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p>Find the counter value when that condition is satisfied with
<code><a href="../reference/ggtrace_inspect_which.html">ggtrace_inspect_which()</a></code>, and then simply check for the
value of <code>._counter_</code> back in
<code><a href="../reference/ggtrace_inspect_return.html">ggtrace_inspect_return()</a></code>:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ggtrace_inspect_which.html">ggtrace_inspect_which</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">p</span>,</span>
<span>  method <span class="op">=</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span>,</span>
<span>  cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">PANEL</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;&amp;</span> <span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 6</span></span></code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">return_val_2_3_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ggtrace_inspect_return.html">ggtrace_inspect_return</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">p</span>,</span>
<span>  method <span class="op">=</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span>,</span>
<span>  cond <span class="op">=</span> <span class="fl">6L</span> <span class="co"># shorthand for `quote(._counter_ == 6L)`</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
<p>These two approaches work the same:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">return_val_2_3_A</span>, <span class="va">return_val_2_3_B</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="capture">
<strong>Capture</strong><a class="anchor" aria-label="anchor" href="#capture"></a>
</h3>
<p>Okay, so we know what <code>StatSmooth$compute_group</code> returns,
but how does this return value change with different input? More
generally put, how does <code>StatSmooth$compute_group</code> behave
under different contexts?</p>
<p>We <em>could</em> answer this by making a bunch of different plots
using <code><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth()</a></code> and repeating the inspection workflow.
Alternatively, we can capture a call to
<code>StatSmooth$compute_group</code> and extract it as a function with
<code><a href="../reference/ggtrace_capture_fn.html">ggtrace_capture_fn()</a></code>:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">captured_fn_2_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ggtrace_capture_fn.html">ggtrace_capture_fn</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">p</span>,</span>
<span>  method <span class="op">=</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span>,</span>
<span>  cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">PANEL</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;&amp;</span> <span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code>captured_fn_2_3</code> is essentially a snapshot of the
<code>compute_group</code> when it is called for the third group of the
second panel. Simply calling <code>captured_fn_2_3</code> gives us the
expected return value:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">return_val_2_3_A</span>, <span class="fu">captured_fn_2_3</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>But the true power of the “capture” workflow functions lies in the
ability to interact with what has been captured. In the case of
<code><a href="../reference/ggtrace_capture_fn.html">ggtrace_capture_fn()</a></code>, the returned function has all of the
arguments passed to it at its execution stored in the formals.</p>
<p>In other words, it is “pre-filled” with its original values, which we
can inspect with <code><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals()</a></code>:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Just showing their type/class for space</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals</a></span><span class="op">(</span><span class="va">captured_fn_2_3</span><span class="op">)</span> , <span class="va">class</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         data       scales       method      formula           se </span></span>
<span><span class="co">## "data.frame"       "list"   "function"    "formula"    "logical" </span></span>
<span><span class="co">##            n         span    fullrange         xseq        level </span></span>
<span><span class="co">##    "numeric"    "numeric"    "logical"       "NULL"    "numeric" </span></span>
<span><span class="co">##  method.args        na.rm  flipped_aes </span></span>
<span><span class="co">##       "list"    "logical"    "logical"</span></span></code></pre>
<p>This makes it very convenient for us to explore its behavior with
different arguments passed to it.</p>
<p>For example, when <code>flipped_aes = TRUE</code>, we get
<code>xmin</code> and <code>xmax</code> columns replacing
<code>ymin</code> and <code>ymax</code>:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span> <span class="fu">captured_fn_2_3</span><span class="op">(</span>flipped_aes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          y        x     xmin     xmax        se flipped_aes</span></span>
<span><span class="co">## 1 15.00000 5.450710 4.369619 6.531802 0.4961840        TRUE</span></span>
<span><span class="co">## 2 15.13924 5.448163 4.385577 6.510749 0.4876904        TRUE</span></span>
<span><span class="co">## 3 15.27848 5.445616 4.401438 6.489794 0.4792416        TRUE</span></span>
<span><span class="co">## 4 15.41772 5.443068 4.417196 6.468941 0.4708400        TRUE</span></span>
<span><span class="co">## 5 15.55696 5.440521 4.432846 6.448196 0.4624882        TRUE</span></span>
<span><span class="co">## 6 15.69620 5.437974 4.448381 6.427566 0.4541888        TRUE</span></span></code></pre>
<p>In this sense, we can effectively simulate what happens in
<code>geom_smooth(orientation = "y")</code> without needing to construct
an entirely different ggplot.</p>
<p>For another example, when we set the confidence interval to 10% with
<code>level = 0.1</code>, the <code>ymin</code> and <code>ymax</code>
values deviate less from the <code>y</code> value:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span> <span class="fu">captured_fn_2_3</span><span class="op">(</span>level <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          x        y     ymin     ymax       se flipped_aes</span></span>
<span><span class="co">## 1 4.000000 21.70513 21.46539 21.94487 1.867921       FALSE</span></span>
<span><span class="co">## 2 4.037975 21.69321 21.45840 21.92801 1.829458       FALSE</span></span>
<span><span class="co">## 3 4.075949 21.68128 21.45137 21.91119 1.791313       FALSE</span></span>
<span><span class="co">## 4 4.113924 21.66936 21.44430 21.89442 1.753509       FALSE</span></span>
<span><span class="co">## 5 4.151899 21.65743 21.43718 21.87769 1.716067       FALSE</span></span>
<span><span class="co">## 6 4.189873 21.64551 21.43001 21.86101 1.679011       FALSE</span></span></code></pre>
<p>Lastly, let’s talk about the <code>data</code> variable we’ve been
using inside the <code>cond</code> argument of some of these workflow
functions. What is <code>data$group</code> and <code>data$PANEL</code>?
How do you know what <code>data</code> looks like?</p>
<p>The answer is actually simple: it’s an argument passed to
<code>StatSmooth$compute_group</code>. We saw earlier that it’s stored
in <code>formals(captured_fn_2_3)</code>, but to target it explicitly we
can also use <code><a href="../reference/ggtrace_inspect_args.html">ggtrace_inspect_args()</a></code>:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">args_2_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ggtrace_inspect_args.html">ggtrace_inspect_args</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">p</span>,</span>
<span>  method <span class="op">=</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span>,</span>
<span>  cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">PANEL</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;&amp;</span> <span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">args_2_3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals</a></span><span class="op">(</span><span class="va">captured_fn_2_3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">args_2_3</span><span class="op">$</span><span class="va">data</span></span></code></pre></div>
<pre><code><span><span class="co">##      x  y colour PANEL group</span></span>
<span><span class="co">## 10 5.3 20      r     2     3</span></span>
<span><span class="co">## 11 5.3 15      r     2     3</span></span>
<span><span class="co">## 12 5.3 20      r     2     3</span></span>
<span><span class="co">## 13 6.0 17      r     2     3</span></span>
<span><span class="co">## 14 6.2 26      r     2     3</span></span>
<span><span class="co">## 15 6.2 25      r     2     3</span></span>
<span><span class="co">## 16 7.0 24      r     2     3</span></span>
<span><span class="co">## 43 5.4 18      r     2     3</span></span>
<span><span class="co">## 48 4.0 26      r     2     3</span></span>
<span><span class="co">## 49 4.0 24      r     2     3</span></span>
<span><span class="co">## 50 4.6 23      r     2     3</span></span>
<span><span class="co">## 51 4.6 22      r     2     3</span></span>
<span><span class="co">## 52 5.4 20      r     2     3</span></span>
<span><span class="co">## 73 5.4 18      r     2     3</span></span></code></pre>
<p>We see that <code>PANEL</code> and <code>group</code> columns
conveniently give us information about the panel and group that
<code>compute_group</code> is doing calculations over.</p>
</div>
<div class="section level3">
<h3 id="highjack">
<strong>Highjack</strong><a class="anchor" aria-label="anchor" href="#highjack"></a>
</h3>
<p>Once we have some understanding of how
<code>StatSmooth$compute_group</code> works, we may want to test some
hypotheses about what would happen to the resulting graphical output if
the method returned something else.</p>
<p>Let’s revisit our examples from the Capture workflow. What if the
third group of the second panel calculated a more conservative
confidence interval (<code>level = 0.1</code>)? What is this effect on
the graphical output?</p>
<p>To answer this question, we use
<code><a href="../reference/ggtrace_highjack_return.html">ggtrace_highjack_return()</a></code> to have a method return an
entirely different value.</p>
<p>First we store the modified return value in some variable:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modified_return_smooth</span> <span class="op">&lt;-</span> <span class="fu">captured_fn_2_3</span><span class="op">(</span>level <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
<p>Then we target the same group inside <code>cond</code> and pass
<code>modified_return_smooth</code> to the <code>value</code>
argument:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ggtrace_highjack_return.html">ggtrace_highjack_return</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">p</span>,</span>
<span>  method <span class="op">=</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span>,</span>
<span>  cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">PANEL</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;&amp;</span> <span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="va">modified_return_smooth</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-25-1.png" width="1093.75"></p>
<p>The confidence band is now nearly invisible for that fitted line
because it’s only capturing a 10% confidence interval!</p>
<p>Here’s another example where we make the method fit predictions from
a loess regression instead. To achieve this directly, we use
<code><a href="../reference/ggtrace_highjack_args.html">ggtrace_highjack_args()</a></code> here and set the
<code>values</code> to <code>list(method = "loess")</code>:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ggtrace_highjack_args.html">ggtrace_highjack_args</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">p</span>,</span>
<span>  method <span class="op">=</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span>,</span>
<span>  cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">PANEL</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;&amp;</span> <span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Failed to fit group 3.</span></span>
<span><span class="co">## Caused by error in `method()`:</span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> could not find function "method"</span></span></code></pre>
<p><img src="overview_files/figure-html/unnamed-chunk-26-1.png" width="1093.75"></p>
<p>Lastly, <code><a href="../reference/ggtrace_highjack_return.html">ggtrace_highjack_return()</a></code> exposes an internal
function called <code><a href="https://rdrr.io/r/base/trace.html" class="external-link">returnValue()</a></code> in the <code>value</code>
argument, which simply returns the original return value. Passing the
<code>value</code> argument an <a href="https://adv-r.hadley.nz/expressions.html" class="external-link"><strong>expression</strong></a>
computing on <code><a href="https://rdrr.io/r/base/trace.html" class="external-link">returnValue()</a></code> allows on-the-fly modifications
to the graphical output.</p>
<p>For example, we can “intercept” the dataframe output of a ggproto
method, do data wrangling on it, and have the method return that new
dataframe instead. Here, we hack the data for the group to make it look
like there’s an absurd degree of heteroskedasticity:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span> <span class="co"># v1.0.8</span></span>
<span></span>
<span><span class="fu"><a href="../reference/ggtrace_highjack_return.html">ggtrace_highjack_return</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">p</span>,</span>
<span>  method <span class="op">=</span> <span class="va">StatSmooth</span><span class="op">$</span><span class="va">compute_group</span>,</span>
<span>  cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">PANEL</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;&amp;</span> <span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/trace.html" class="external-link">returnValue</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        ymin <span class="op">=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">se</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        ymax <span class="op">=</span> <span class="va">y</span> <span class="op">+</span> <span class="va">se</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-27-1.png" width="1093.75"></p>
</div>
</div>
<div class="section level2">
<h2 id="middle-ground-approach-with_ggtrace">
<strong>Middle-ground approach
<code>with_ggtrace()</code></strong><a class="anchor" aria-label="anchor" href="#middle-ground-approach-with_ggtrace"></a>
</h2>
<p>So far we’ve seen the low-level function <code><a href="../reference/ggtrace.html">ggtrace()</a></code> and
the high-level family of workflow functions
<code>ggtrace_{action}_{value}()</code>. But once you get more familiar
with ggplot internals and start using <code><a href="../reference/ggtrace.html">ggtrace()</a></code> to “hack
into” the internals (moving from <em>learner</em> to <em>developer</em>,
in a sense), you might want both exploit both the power and convenience
that <a href="https://yjunechoe.github.io/ggtrace">ggtrace</a> provides across these two designs.</p>
<p>For that we provide <code><a href="../reference/with_ggtrace.html">with_ggtrace()</a></code>, which wraps around
<code><a href="../reference/ggtrace.html">ggtrace()</a></code> to give you access to its full power, while
keeping its effects localized (e.g., no side-effects) and therefore
making it more fitting for a functional programming workflow.</p>
<p>Like <code><a href="../reference/ggtrace.html">ggtrace()</a></code>, you can inject code into different steps
of a method <em>as it runs</em>:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/with_ggtrace.html">with_ggtrace</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">year</span> <span class="op">~</span> <span class="va">drv</span><span class="op">)</span>,</span>
<span>  method <span class="op">=</span> <span class="va">Layout</span><span class="op">$</span><span class="va">render</span>,</span>
<span>  trace_steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5L</span>, <span class="fl">8L</span><span class="op">)</span>,</span>
<span>  trace_exprs <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="op">{</span></span>
<span>      <span class="co"># First, turn all panels except the 4th semi-transparent</span></span>
<span>      <span class="va">panels</span><span class="op">[</span><span class="op">-</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">panels</span><span class="op">[</span><span class="op">-</span><span class="fl">4</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">panel</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.edit.html" class="external-link">editGrob</a></span><span class="op">(</span><span class="va">panel</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.4</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>      <span class="co"># Second, give red outline and fill to 4th panel</span></span>
<span>      <span class="va">panels</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html" class="external-link">gTree</a></span><span class="op">(</span>children <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html" class="external-link">gList</a></span><span class="op">(</span><span class="va">panels</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.rect.html" class="external-link">rectGrob</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0.5</span>, y <span class="op">=</span> <span class="fl">0.5</span>, width <span class="op">=</span> <span class="fl">1</span>, height <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                 gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">5</span>, fill <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    </span>
<span>    <span class="op">{</span></span>
<span>      <span class="co"># Third, give it some emphasis by connecting to facet strips</span></span>
<span>      <span class="va">outline_rect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.rect.html" class="external-link">rectGrob</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="fl">0.5</span>, y <span class="op">=</span> <span class="fl">0.5</span>, width <span class="op">=</span> <span class="fl">1</span>, height <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="va">plot_table</span> <span class="op">&lt;-</span> <span class="fu">gtable_add_grob</span><span class="op">(</span></span>
<span>        <span class="va">plot_table</span>, <span class="va">outline_rect</span>,</span>
<span>        t <span class="op">=</span> <span class="fl">1</span>, l <span class="op">=</span> <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">5</span>, r <span class="op">=</span> <span class="fl">2</span>, z <span class="op">=</span> <span class="cn">Inf</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="va">plot_table</span> <span class="op">&lt;-</span> <span class="fu">gtable_add_grob</span><span class="op">(</span></span>
<span>        <span class="va">plot_table</span>, <span class="va">outline_rect</span>,</span>
<span>        t <span class="op">=</span> <span class="fl">5</span>, l <span class="op">=</span> <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">5</span>, r <span class="op">=</span> <span class="fl">7</span>, z <span class="op">=</span> <span class="cn">Inf</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">)</span>,</span>
<span>  out <span class="op">=</span> <span class="st">"g"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-28-1.png" width="1093.75"></p>
<p>And like the workflow functions, you can have conditional traces that
only evaluate when a condition is met, using <code>if</code> statements
inside <code>trace_exprs</code> with <code>once = FALSE</code>.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/with_ggtrace.html">with_ggtrace</a></span><span class="op">(</span></span>
<span>  <span class="va">p</span>,</span>
<span>  <span class="va">GeomRibbon</span><span class="op">$</span><span class="va">draw_group</span>,</span>
<span>  trace_steps <span class="op">=</span> <span class="op">-</span><span class="fl">1L</span>,</span>
<span>  trace_exprs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># Give gradient fill to the confidence bands for third group</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">g_poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.edit.html" class="external-link">editGrob</a></span><span class="op">(</span></span>
<span>        <span class="va">g_poly</span>,</span>
<span>        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/patterns.html" class="external-link">linearGradient</a></span><span class="op">(</span></span>
<span>          colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"purple"</span>, <span class="st">"skyblue"</span>, <span class="st">"pink"</span><span class="op">)</span>,</span>
<span>          stops <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>          x1 <span class="op">=</span> <span class="fl">0</span>, x2 <span class="op">=</span> <span class="fl">1</span>, y1 <span class="op">=</span> <span class="fl">0</span>, y2 <span class="op">=</span> <span class="fl">0</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span>,</span>
<span>  once <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># to test `if` for all calls to method</span></span>
<span>  out <span class="op">=</span> <span class="st">"g"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-29-1.png" width="1093.75"></p>
<p>And of course, all of this is not limited to objects from the
<a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a> package itself. You can have fun hacking
extension packages as well!</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/teunbrand/ggh4x" class="external-link">ggh4x</a></span><span class="op">)</span> <span class="co"># v0.2.1</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'ggh4x'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:ggplot2':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     guide_axis_logticks</span></span></code></pre>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example from - https://teunbrand.github.io/ggh4x/articles/Facets.html ----</span></span>
<span></span>
<span><span class="co">## Base plot ====</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">displ</span>, <span class="va">hwy</span>, colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Engine displacement"</span>, y <span class="op">=</span> <span class="st">"Highway miles per gallon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Fixed-aspect plot w/ independent scales using `ggh4x::facet_grid2()` ====</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span></span>
<span>  <span class="fu">ggh4x</span><span class="fu">::</span><span class="fu"><a href="https://teunbrand.github.io/ggh4x/reference/facet_grid2.html" class="external-link">facet_grid2</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">drv</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span>, independent <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_grey</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Highjacking the plot's execution using `ggtrace::with_ggtrace()` ----</span></span>
<span><span class="fu"><a href="../reference/with_ggtrace.html">with_ggtrace</a></span><span class="op">(</span></span>
<span>  </span>
<span>  <span class="co">## Argument 1: The ggplot to interact with durings its execution ====</span></span>
<span>  x <span class="op">=</span> <span class="va">p2</span>,</span>
<span>  </span>
<span>  <span class="co">## Argument 2: The method to inject code into ====</span></span>
<span>  method <span class="op">=</span> <span class="fu">ggh4x</span><span class="fu">::</span><span class="va"><a href="https://teunbrand.github.io/ggh4x/reference/ggh4x_extensions.html" class="external-link">FacetGrid2</a></span><span class="op">$</span><span class="va">draw_panels</span>,</span>
<span>  </span>
<span>  <span class="co">## Argument 3: The step in the method right before `panels` and `axes` ====</span></span>
<span>  <span class="co">## are merged into the `panel_table` &lt;gtable&gt; and shipped off</span></span>
<span>  trace_steps <span class="op">=</span> <span class="fl">13</span>, <span class="co"># See `ggbody(FacetGrid2$draw_panels)`</span></span>
<span>  </span>
<span>  <span class="co">## Argument 4: The code injection to rotate the 2nd panel ====</span></span>
<span>  trace_exprs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="co">### FIRST, specify row/column of panel to target ####</span></span>
<span>    <span class="va">row</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="va">col</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span>    <span class="va">target_panel</span> <span class="op">&lt;-</span> <span class="va">layout</span><span class="op">[</span><span class="va">layout</span><span class="op">$</span><span class="va">ROW</span> <span class="op">==</span> <span class="va">row</span> <span class="op">&amp;</span> <span class="va">layout</span><span class="op">$</span><span class="va">COL</span> <span class="op">==</span> <span class="va">col</span>, <span class="op">]</span><span class="op">$</span><span class="va">PANEL</span></span>
<span>    <span class="va">left_axis</span>    <span class="op">&lt;-</span> <span class="va">axes</span><span class="op">$</span><span class="va">left</span><span class="op">[[</span><span class="va">row</span>, <span class="va">col</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">bottom_axis</span>  <span class="op">&lt;-</span> <span class="va">axes</span><span class="op">$</span><span class="va">bottom</span><span class="op">[[</span><span class="va">row</span>, <span class="va">col</span><span class="op">]</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co">### SECOND, replace target panel with a version of itself ####</span></span>
<span>    <span class="co">### that has axes attached to it, using `grid::gTree()`</span></span>
<span>    <span class="va">panels</span><span class="op">[[</span><span class="va">target_panel</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html" class="external-link">gTree</a></span><span class="op">(</span></span>
<span>      </span>
<span>      <span class="co">##### Argument `children`: a list (`grid::gList()`) of three grobs:</span></span>
<span>      children <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html" class="external-link">gList</a></span><span class="op">(</span></span>
<span>        </span>
<span>        <span class="co">###### 1. The original panel itself</span></span>
<span>        <span class="va">panels</span><span class="op">[[</span><span class="va">target_panel</span><span class="op">]</span><span class="op">]</span>,</span>
<span>        </span>
<span>        <span class="co">###### 2. Resized/repositioned left y-axis for that panel</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.edit.html" class="external-link">editGrob</a></span><span class="op">(</span></span>
<span>          <span class="va">left_axis</span>,</span>
<span>          vp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html" class="external-link">viewport</a></span><span class="op">(</span></span>
<span>            x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"npc"</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grobWidth.html" class="external-link">grobWidth</a></span><span class="op">(</span><span class="va">left_axis</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>            just <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"right"</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        </span>
<span>        <span class="co">###### 3. Resized/repositioned bottom x-axis for that panel</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.edit.html" class="external-link">editGrob</a></span><span class="op">(</span></span>
<span>          <span class="va">bottom_axis</span>,</span>
<span>          vp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html" class="external-link">viewport</a></span><span class="op">(</span></span>
<span>            y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"npc"</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grobWidth.html" class="external-link">grobHeight</a></span><span class="op">(</span><span class="va">bottom_axis</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>            just <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"top"</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>        </span>
<span>      <span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="co">##### Argument `vp`: Rotation for this combination of three grobs</span></span>
<span>      vp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html" class="external-link">viewport</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">.7</span>, height <span class="op">=</span> <span class="fl">.7</span>, angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">### THIRD, "remove" the original axes for that panel ####</span></span>
<span>    <span class="va">axes</span><span class="op">$</span><span class="va">left</span><span class="op">[[</span><span class="va">row</span>, <span class="va">col</span><span class="op">]</span><span class="op">]</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/zeroGrob.html" class="external-link">zeroGrob</a></span><span class="op">(</span><span class="op">)</span> </span>
<span>    <span class="va">axes</span><span class="op">$</span><span class="va">bottom</span><span class="op">[[</span><span class="va">row</span>, <span class="va">col</span><span class="op">]</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/zeroGrob.html" class="external-link">zeroGrob</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co">## Argument `out`: The return value for `with_ggtrace()` ====</span></span>
<span>  <span class="co">## "gtable" returns the graphical output after injecting the code</span></span>
<span>  out <span class="op">=</span> <span class="st">"gtable"</span> <span class="co"># you can also use the "g" shorthand</span></span>
<span>  </span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in grid.Call.graphics(C_setviewport, vp, TRUE): cannot clip to rotated</span></span>
<span><span class="co">## viewport</span></span></code></pre>
<p><img src="overview_files/figure-html/unnamed-chunk-30-1.png" width="1093.75"></p>
</div>
<div class="section level2">
<h2 id="case-study-data-driven-legends">
<strong>Case study: Data-driven legends</strong><a class="anchor" aria-label="anchor" href="#case-study-data-driven-legends"></a>
</h2>
<p>Suppose we want to change the fill legend key from squares to the
actual violins drawn for each category:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">violin_plot</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/starwars.html" class="external-link">starwars</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"Human"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    aspect.ratio <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"in"</span><span class="op">)</span>,</span>
<span>    legend.key <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">violin_plot</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-31-1.png" width="1093.75"></p>
<p>We know that each violin is drawn by
<code>GeomViolin$draw_group</code>, called for each group in the
plot.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ggtrace_inspect_n.html">ggtrace_inspect_n</a></span><span class="op">(</span><span class="va">violin_plot</span>, <span class="va">GeomViolin</span><span class="op">$</span><span class="va">draw_group</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2</span></span></code></pre>
<p>Let’s grab the plotted violins with
<code><a href="../reference/ggtrace_inspect_return.html">ggtrace_inspect_return()</a></code></p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">violins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">ggtrace_inspect_return</span>,</span>
<span>                  x <span class="op">=</span> <span class="va">violin_plot</span>, method <span class="op">=</span> <span class="va">GeomViolin</span><span class="op">$</span><span class="va">draw_group</span><span class="op">)</span></span>
<span><span class="va">violins</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## polygon[geom_violin.polygon.2724] </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## polygon[geom_violin.polygon.2784]</span></span></code></pre>
<p>Then, we can use <code><a href="../reference/ggtrace_highjack_return.html">ggtrace_highjack_return()</a></code> to highjack
the return value of the key drawing method
<code>GeomViolin$draw_key</code> such that it returns the output from
the <code>draw_group</code> method instead. We set
<code>cond = 1:2</code> and
<code>value = substitute(violins[[._counter_]])</code> so that the
<code>draw_key</code> method returns the first violin as the first
legend key, and the second violin as the second legend key.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ggtrace_highjack_return.html">ggtrace_highjack_return</a></span><span class="op">(</span></span>
<span>  <span class="va">violin_plot</span>,</span>
<span>  <span class="va">GeomViolin</span><span class="op">$</span><span class="va">draw_key</span>,</span>
<span>  cond <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="co"># or `cond = TRUE` since method is called twice total</span></span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span><span class="va">violins</span><span class="op">[[</span><span class="va">._counter_</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-34-1.png" width="1093.75"></p>
<p>Note that violins in the legend are drawn with respect to the panel
coordinate system, because that’s how the <code>draw_group</code> method
does things. For a cleaner look, we use the defined function
<code>center_and_resize()</code> which modifies the violin grob using
<code><a href="https://rdrr.io/r/grid/grid.edit.html" class="external-link">grid::editGrob()</a></code> before passing them off to
<code><a href="../reference/ggtrace_highjack_return.html">ggtrace_highjack_return()</a></code>.</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span><span class="va">center_and_resize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">grob</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">grob</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">y_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">grob</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">width</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">x_range</span><span class="op">)</span></span>
<span>  <span class="va">height</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">y_range</span><span class="op">)</span></span>
<span>  <span class="va">resizing</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">width</span>, <span class="va">height</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.edit.html" class="external-link">editGrob</a></span><span class="op">(</span><span class="va">grob</span>, vp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html" class="external-link">viewport</a></span><span class="op">(</span></span>
<span>    xscale <span class="op">=</span> <span class="va">x_range</span>, yscale <span class="op">=</span> <span class="va">y_range</span>,</span>
<span>    width <span class="op">=</span> <span class="va">width</span> <span class="op">*</span> <span class="va">resizing</span>, height <span class="op">=</span> <span class="va">height</span> <span class="op">*</span> <span class="va">resizing</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">violins_centered_resized</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">violins</span>, <span class="va">center_and_resize</span><span class="op">)</span></span>
<span></span>
<span><span class="va">violin_plot_highjacked</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ggtrace_highjack_return.html">ggtrace_highjack_return</a></span><span class="op">(</span></span>
<span>  <span class="va">violin_plot</span>,</span>
<span>  <span class="va">GeomViolin</span><span class="op">$</span><span class="va">draw_key</span>,</span>
<span>  cond <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span><span class="va">violins_centered_resized</span><span class="op">[[</span><span class="va">._counter_</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">violin_plot_highjacked</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-35-1.png" width="1093.75"></p>
<p>To keep this effect while keeping the violin_plot a ggplot object,
you can create a custom key glyph function that inspects the fill color
of the original legend keys and returns the corresponding violin.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">violins_centered_resized</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#F8766D"</span>, <span class="st">"#00BFC4"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">violin_plot_keyglyph</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/starwars.html" class="external-link">starwars</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"Human"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span>,</span>
<span>    key_glyph <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span>, <span class="va">size</span><span class="op">)</span> <span class="op">{</span>   <span class="co">#&lt;</span></span>
<span>      <span class="va">violins_centered_resized</span><span class="op">[[</span><span class="va">data</span><span class="op">$</span><span class="va">fill</span><span class="op">]</span><span class="op">]</span>      <span class="co">#&lt;  Custom `key_glyph` function</span></span>
<span>    <span class="op">}</span>                                            <span class="co">#&lt;</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    aspect.ratio <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"in"</span><span class="op">)</span>,</span>
<span>    legend.key <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Note the difference in output between the two methods. While highjack
workflow functions offer a convenient way of modifying a ggplot, it
forces the conversion of a ggplot object into a grob.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">violin_plot_highjacked</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "ggtrace_highjacked" "gtable"             "gTree"             </span></span>
<span><span class="co">## [4] "grob"               "gDesc"</span></span></code></pre>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">violin_plot_highjacked</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Violin plot with data-driven legend key glyphs"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NULL</span></span></code></pre>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">violin_plot_keyglyph</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "gg"     "ggplot"</span></span></code></pre>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">violin_plot_keyglyph</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Violin plot with data-driven legend key glyphs"</span><span class="op">)</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-37-1.png" width="1093.75"></p>
<p>The lesson here is that the highjack workflow (and the {ggtrace}
package, more broadly) is the means, not the end. Users are encouraged
to generalize solutions beyond one-off hacks using the toolkit of
workflow functions to determine the appropriate point of extension.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://yjunechoe.github.io" class="external-link">June Choe</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
