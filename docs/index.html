<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ggtrace ‚Ä¢ ggtrace</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="ggtrace">
<meta property="og:description" content="Debug ggproto methods with trace">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">ggtrace</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Usage</li>
    <li>
      <a href="articles/intro.html">Introduction to ggtrace()</a>
    </li>
    <li>
      <a href="articles/usecase-aes_eval.html">Usecase: aes evaluation</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Miscellaneous</li>
    <li>
      <a href="articles/comparisons.html">Comparison of debugging methods</a>
    </li>
    <li>
      <a href="articles/metaprogramming.html">Metaprogramming with trace()</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://github.com/yjunechoe/ggtrace/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="ggtrace" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#ggtrace" class="anchor"></a><strong>{ggtrace}</strong>
</h1></div>
<!-- badges: start -->
<!-- badges: end -->
<div id="programmatically-inspect-debug-and-manipulate-ggproto-methods" class="section level4">
<h4 class="hasAnchor">
<a href="#programmatically-inspect-debug-and-manipulate-ggproto-methods" class="anchor"></a><strong>Programmatically inspect, debug, and manipulate ggproto methods</strong>
</h4>
</div>
<div id="why-ggtrace" class="section level2">
<h2 class="hasAnchor">
<a href="#why-ggtrace" class="anchor"></a><strong>Why {ggtrace}?</strong>
</h2>
<ul>
<li>
<strong>Lightweight</strong> ‚ö°
<ul>
<li>The only dependency is <a href="https://rlang.r-lib.org">rlang</a> - not even <a href="https://ggplot2.tidyverse.org">ggplot2</a>!</li>
<li>Not a lot of code - most of the heavy lifting is done by <code><a href="https://rdrr.io/r/base/trace.html">base::trace()</a></code>
</li>
</ul>
</li>
<li>
<strong>User-friendly</strong> ‚ù§
<ul>
<li>Everything happens in your local session - no need to fork a repo to inspect the internals!</li>
<li>Multiple expressions can be passed in for evaluation inside method body at specified steps</li>
<li>The output is available for inspection outside of the debugging context with <code><a href="reference/last_ggtrace.html">last_ggtrace()</a></code>
</li>
<li>Calls <code><a href="reference/gguntrace.html">gguntrace()</a></code> on itself on exit by default (a wrapper around <code><a href="https://rdrr.io/r/base/trace.html">base::untrace()</a></code>)</li>
</ul>
</li>
<li>
<strong>Flexible</strong> üõ†
<ul>
<li>You can <em>programmatically</em> debug with <code><a href="reference/ggtrace.html">ggtrace()</a></code> or <em>interactively</em> debug with <code><a href="reference/ggedit.html">ggedit()</a></code>
</li>
<li>Since <code><a href="reference/ggtrace.html">ggtrace()</a></code> doesn‚Äôt rely on interactivity, it can be used in <a href="https://reprex.tidyverse.org">reprex</a>-es</li>
<li>Works with other object oriented systems in R (e.g., R6), not just ggproto!</li>
</ul>
</li>
<li>
<strong>Powerful</strong> üí™
<ul>
<li>Return the method‚Äôs runtime environment with <code><a href="reference/ggtrace.html">ggtrace()</a></code> for further inspection</li>
<li>Modify the method‚Äôs runtime environment by passing assignment expressions to <code><a href="reference/ggtrace.html">ggtrace()</a></code>
</li>
<li>Change the source code with <code><a href="reference/ggedit.html">ggedit()</a></code>, which is restored upon <code><a href="reference/gguntrace.html">gguntrace()</a></code>
</li>
<li>Insert <code><a href="https://rdrr.io/r/base/browser.html">browser()</a></code> and <code><a href="https://rdrr.io/r/base/debug.html">debug()</a></code> calls deep inside the method body with <code><a href="reference/ggedit.html">ggedit()</a></code>
</li>
</ul>
</li>
</ul>
<p>More on the üì¶ package website: <a href="https://yjunechoe.github.io/ggtrace" class="uri">https://yjunechoe.github.io/ggtrace</a></p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a><strong>Installation</strong>
</h2>
<p>You can install the development version from <a href="https://github.com/">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("devtools")</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"yjunechoe/ggtrace"</span><span class="op">)</span></code></pre></div>
</div>
<div id="usage" class="section level2">
<h2 class="hasAnchor">
<a href="#usage" class="anchor"></a><strong>Usage</strong>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yjunechoe.github.io/ggtrace">ggtrace</a></span><span class="op">)</span> <span class="co"># v0.3.2</span></code></pre></div>
</div>
<div id="example-1---compute_layer-method-from-positionjitter" class="section level2">
<h2 class="hasAnchor">
<a href="#example-1---compute_layer-method-from-positionjitter" class="anchor"></a><strong>Example 1 - <code>compute_layer</code> method from <code>PositionJitter</code></strong>
</h2>
<div id="step-1-make-plot" class="section level3">
<h3 class="hasAnchor">
<a href="#step-1-make-plot" class="anchor"></a><strong>Step 1. Make plot</strong>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span> <span class="co"># v3.3.5</span>

<span class="va">jitter_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>,<span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">cut</span>, <span class="va">depth</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitter.html">position_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.2</span>, seed <span class="op">=</span> <span class="fl">2021</span><span class="op">)</span><span class="op">)</span>
<span class="va">jitter_plot</span></code></pre></div>
<p><img src="reference/figures/README-ex-1-setup-1.png" width="100%"></p>
</div>
<div id="step-2-inspect-body-of-the-ggproto-method" class="section level3">
<h3 class="hasAnchor">
<a href="#step-2-inspect-body-of-the-ggproto-method" class="anchor"></a><strong>Step 2. Inspect body of the ggproto method</strong>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/ggbody.html">ggbody</a></span><span class="op">(</span><span class="va">PositionJitter</span><span class="op">$</span><span class="va">compute_layer</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; `{`</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; trans_x &lt;- if (params$width &gt; 0) function(x) jitter(x, amount = params$width)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; trans_y &lt;- if (params$height &gt; 0) function(x) jitter(x, amount = params$height)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; x_aes &lt;- intersect(ggplot_global$x_aes, names(data))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[5]]</span>
<span class="co">#&gt; x &lt;- if (length(x_aes) == 0) 0 else data[[x_aes[1]]]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[6]]</span>
<span class="co">#&gt; y_aes &lt;- intersect(ggplot_global$y_aes, names(data))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[7]]</span>
<span class="co">#&gt; y &lt;- if (length(y_aes) == 0) 0 else data[[y_aes[1]]]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[8]]</span>
<span class="co">#&gt; dummy_data &lt;- new_data_frame(list(x = x, y = y), nrow(data))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[9]]</span>
<span class="co">#&gt; fixed_jitter &lt;- with_seed_null(params$seed, transform_position(dummy_data, </span>
<span class="co">#&gt;     trans_x, trans_y))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[10]]</span>
<span class="co">#&gt; x_jit &lt;- fixed_jitter$x - x</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[11]]</span>
<span class="co">#&gt; y_jit &lt;- fixed_jitter$y - y</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[12]]</span>
<span class="co">#&gt; transform_position(data, function(x) x + x_jit, function(x) x + </span>
<span class="co">#&gt;     y_jit)</span></code></pre></div>
</div>
<div id="step-3-ggtrace---including-the-last-line-with-keyword-step" class="section level3">
<h3 class="hasAnchor">
<a href="#step-3-ggtrace---including-the-last-line-with-keyword-step" class="anchor"></a><strong>Step 3. <code>ggtrace()</code> - including the last line with keyword <code>~step</code></strong>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/ggtrace.html">ggtrace</a></span><span class="op">(</span>
  method <span class="op">=</span> <span class="va">PositionJitter</span><span class="op">$</span><span class="va">compute_layer</span>,
  trace_steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">9</span>, <span class="fl">12</span><span class="op">)</span>,
  trace_exprs <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">exprs</a></span><span class="op">(</span>
    <span class="va">data</span>,            <span class="co"># What does the data passed in look like?</span>
    <span class="va">params</span>,          <span class="co"># What do the initial parameters look like?</span>
    <span class="va">dummy_data</span>,      <span class="co"># What is `dummy_data` defined at Step 8?</span>
    <span class="op">~</span><span class="va">step</span>            <span class="co"># What does the last line evaluate to?</span>
                     <span class="co"># - i.e., what is returned by the method?</span>
  <span class="op">)</span>,
  .print <span class="op">=</span> <span class="cn">FALSE</span>     <span class="co"># Don't print evaluated expressions to console</span>
<span class="op">)</span>
<span class="co">#&gt; PositionJitter$compute_layer now being traced</span>

<span class="co"># plot not printed to save space</span>
<span class="va">jitter_plot</span>
<span class="co">#&gt; Triggering trace on PositionJitter$compute_layer </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 1]&gt; data </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 1]&gt; params </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 9]&gt; dummy_data </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 12]&gt; transform_position(data, function(x) x + x_jit, function(x) x + y_jit) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call `last_ggtrace()` to get the trace dump.</span>
<span class="co">#&gt; Untracing PositionJitter$compute_layer</span></code></pre></div>
</div>
<div id="step-4-inspect-trace-dump" class="section level3">
<h3 class="hasAnchor">
<a href="#step-4-inspect-trace-dump" class="anchor"></a><strong>Step 4. Inspect trace dump</strong>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">jitter_tracedump</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/last_ggtrace.html">last_ggtrace</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">jitter_tracedump</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; $width</span>
<span class="co">#&gt; [1] 0.2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $height</span>
<span class="co">#&gt; [1] 0.04</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $seed</span>
<span class="co">#&gt; [1] 2021</span>

<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">jitter_tracedump</span><span class="op">[</span><span class="op">-</span><span class="fl">2</span><span class="op">]</span>, <span class="va">nrow</span><span class="op">)</span>
<span class="co">#&gt; $`[Step 1]&gt; data`</span>
<span class="co">#&gt; [1] 1000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`[Step 9]&gt; dummy_data`</span>
<span class="co">#&gt; [1] 1000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`[Step 12]&gt; transform_position(data, function(x) x + x_jit, function(x) x + y_jit)`</span>
<span class="co">#&gt; [1] 1000</span>

<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">jitter_tracedump</span><span class="op">[</span><span class="op">-</span><span class="fl">2</span><span class="op">]</span>, <span class="va">head</span>, <span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt; $`[Step 1]&gt; data`</span>
<span class="co">#&gt;   x    y PANEL group</span>
<span class="co">#&gt; 1 5 61.5     1     5</span>
<span class="co">#&gt; 2 4 59.8     1     4</span>
<span class="co">#&gt; 3 2 56.9     1     2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`[Step 9]&gt; dummy_data`</span>
<span class="co">#&gt;   x    y</span>
<span class="co">#&gt; 1 5 61.5</span>
<span class="co">#&gt; 2 4 59.8</span>
<span class="co">#&gt; 3 2 56.9</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`[Step 12]&gt; transform_position(data, function(x) x + x_jit, function(x) x + y_jit)`</span>
<span class="co">#&gt;          x        y PANEL group</span>
<span class="co">#&gt; 1 4.980507 61.50684     1     5</span>
<span class="co">#&gt; 2 4.113512 59.77872     1     4</span>
<span class="co">#&gt; 3 2.083873 56.86655     1     2</span></code></pre></div>
</div>
</div>
<div id="example-2---draw_group-method-from-geomsmooth" class="section level2">
<h2 class="hasAnchor">
<a href="#example-2---draw_group-method-from-geomsmooth" class="anchor"></a><strong>Example 2 - <code>draw_group</code> method from <code>GeomSmooth</code></strong>
</h2>
<div id="step-1-make-plot-1" class="section level3">
<h3 class="hasAnchor">
<a href="#step-1-make-plot-1" class="anchor"></a><strong>Step 1. Make plot</strong>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">smooth_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">hp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">stat_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span><span class="op">)</span>
<span class="va">smooth_plot</span></code></pre></div>
<p><img src="reference/figures/README-ex-2-setup-1.png" width="100%"></p>
</div>
<div id="step-2-inspect-body-of-the-ggproto-method-1" class="section level3">
<h3 class="hasAnchor">
<a href="#step-2-inspect-body-of-the-ggproto-method-1" class="anchor"></a><strong>Step 2. Inspect body of the ggproto method</strong>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/ggbody.html">ggbody</a></span><span class="op">(</span><span class="va">GeomSmooth</span><span class="op">$</span><span class="va">draw_group</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; `{`</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; ribbon &lt;- transform(data, colour = NA)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; path &lt;- transform(data, alpha = NA)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; ymin = flipped_names(flipped_aes)$ymin</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[5]]</span>
<span class="co">#&gt; ymax = flipped_names(flipped_aes)$ymax</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[6]]</span>
<span class="co">#&gt; has_ribbon &lt;- se &amp;&amp; !is.null(data[[ymax]]) &amp;&amp; !is.null(data[[ymin]])</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[7]]</span>
<span class="co">#&gt; gList(if (has_ribbon) GeomRibbon$draw_group(ribbon, panel_params, </span>
<span class="co">#&gt;     coord, flipped_aes = flipped_aes), GeomLine$draw_panel(path, </span>
<span class="co">#&gt;     panel_params, coord))</span></code></pre></div>
</div>
<div id="step-3-ggtrace---get-the-glist" class="section level3">
<h3 class="hasAnchor">
<a href="#step-3-ggtrace---get-the-glist" class="anchor"></a><strong>Step 3. <code>ggtrace()</code> - get the <code>gList()</code></strong>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/ggtrace.html">ggtrace</a></span><span class="op">(</span>
  method <span class="op">=</span> <span class="va">GeomSmooth</span><span class="op">$</span><span class="va">draw_group</span>,
  trace_steps <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,           <span class="co"># Trace the last line</span>
  trace_exprs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span><span class="op">(</span><span class="op">~</span><span class="va">step</span><span class="op">)</span>, <span class="co"># Grab the gList() object it returns</span>
  .print <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="co">#&gt; GeomSmooth$draw_group now being traced</span>

<span class="co"># plot not printed to save space</span>
<span class="va">smooth_plot</span>
<span class="co">#&gt; Triggering trace on GeomSmooth$draw_group </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 7]&gt; gList(if (has_ribbon) GeomRibbon$draw_group(ribbon, panel_params, coord,</span>
<span class="co">#&gt;    flipped_aes = flipped_aes), GeomLine$draw_panel(path, panel_params, coord)) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call `last_ggtrace()` to get the trace dump.</span>
<span class="co">#&gt; Untracing GeomSmooth$draw_group</span></code></pre></div>
</div>
<div id="step-4-inspect-trace-dump-1" class="section level3">
<h3 class="hasAnchor">
<a href="#step-4-inspect-trace-dump-1" class="anchor"></a><strong>Step 4. Inspect trace dump</strong>
</h3>
<p>Get grobs in the gList and do some weird stuff with it.</p>
<p>This is nice because you don‚Äôt have to navigate the whole list of <code>ggplotGrob(smooth_plot)[["grobs"]]</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">smooth_tracedump</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/last_ggtrace.html">last_ggtrace</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">smooth_gList</span> <span class="op">&lt;-</span> <span class="va">smooth_tracedump</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="va">smooth_gList</span>
<span class="co">#&gt; (gTree[geom_ribbon.gTree.132], polyline[GRID.polyline.133])</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/grid/grid.ls.html">grid.ls</a></span><span class="op">(</span><span class="va">smooth_gList</span><span class="op">)</span>
<span class="co">#&gt; geom_ribbon.gTree.132</span>
<span class="co">#&gt;   GRID.polygon.129</span>
<span class="co">#&gt;   GRID.polyline.130</span>
<span class="co">#&gt; GRID.polyline.133</span>

<span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gTree</a></span><span class="op">(</span>children <span class="op">=</span> <span class="va">smooth_gList</span>, vp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-ex-2-last-a-1.png" width="20%"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># The weird stuff</span>

<span class="va">smooth_ribbon_polygon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.edit.html">editGrob</a></span><span class="op">(</span>
  <span class="va">smooth_gList</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  <span class="st">"polygon"</span>,
  grep <span class="op">=</span> <span class="cn">TRUE</span>,
  gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#b742ce"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">smooth_ribbon_gTree</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gTree</a></span><span class="op">(</span>
  children <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gList</a></span><span class="op">(</span>
    <span class="va">smooth_ribbon_polygon</span>,
    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="st">"Weee"</span>, x <span class="op">=</span> <span class="fl">.7</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, fontsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">10</span>, <span class="st">"pt"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>,
  vp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">1</span>, height <span class="op">=</span> <span class="fl">1</span>, default.units <span class="op">=</span> <span class="st">"in"</span>, angle <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">smooth_ribbon_gTree</span><span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-ex-2-last-a-2.png" width="20%"></p>
<p>You might use this for some fancy <em>data-driven legends</em> or something, though it‚Äôs meant to be exploratory not practical.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>
<span class="va">smooth_plot</span> <span class="op">+</span>
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/inset_element.html">inset_element</a></span><span class="op">(</span>
    <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_elements.html">wrap_elements</a></span><span class="op">(</span>full <span class="op">=</span> <span class="va">smooth_ribbon_gTree</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>,
    left <span class="op">=</span> <span class="fl">0.5</span>, bottom <span class="op">=</span> <span class="fl">0.5</span>, right <span class="op">=</span> <span class="fl">0.8</span>, top <span class="op">=</span> <span class="fl">0.8</span>
  <span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-ex-2-last-b-1.png" width="100%"></p>
</div>
</div>
<div id="example-3---compute_panel-method-from-statboxplot" class="section level2">
<h2 class="hasAnchor">
<a href="#example-3---compute_panel-method-from-statboxplot" class="anchor"></a><strong>Example 3 - <code>compute_panel</code> method from <code>StatBoxplot</code></strong>
</h2>
<div id="step-1-make-plot-2" class="section level3">
<h3 class="hasAnchor">
<a href="#step-1-make-plot-2" class="anchor"></a><strong>Step 1. Make plot</strong>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">boxplot_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">500</span>,<span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">cut</span>, <span class="va">depth</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">boxplot_plot</span></code></pre></div>
<p><img src="reference/figures/README-ex-3-setup-1.png" width="100%"></p>
</div>
<div id="step-2-inspect-body-of-the-ggproto-method-2" class="section level3">
<h3 class="hasAnchor">
<a href="#step-2-inspect-body-of-the-ggproto-method-2" class="anchor"></a><strong>Step 2. Inspect body of the ggproto method</strong>
</h3>
<p>Actually, <code>"compute_panel"</code> method is not defined for <code>StatBoxplot</code>. <code><a href="reference/ggbody.html">ggbody()</a></code> gives you a hint that it may be inherited.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/ggbody.html">ggbody</a></span><span class="op">(</span><span class="va">StatBoxplot</span><span class="op">$</span><span class="va">compute_panel</span><span class="op">)</span>
<span class="co">#&gt; Error: Method compute_panel is not defined for StatBoxplot</span>
<span class="co">#&gt; Check inheritance with `ggbody(StatBoxplot$compute_panel, inherit = TRUE)`</span></code></pre></div>
<p><code>StatBoxplot</code> is a child of the parent ggproto <code>Stat</code>, and the <code>"compute_panel"</code> method is inherited from <code>Stat</code> as well, so that‚Äôs what we want to trace instead:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">StatBoxplot</span><span class="op">)</span>
<span class="co">#&gt; [1] "StatBoxplot" "Stat"        "ggproto"     "gg"</span></code></pre></div>
<p>With <code>inherit = TRUE</code>, <code><a href="reference/ggbody.html">ggbody()</a></code> returns the method as defined in the closest parent, and the corresponding code to get it. We confirm that we should be passing <code>Stat$compute_panel</code> to the <code>method</code> argument for <code><a href="reference/ggtrace.html">ggtrace()</a></code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/ggbody.html">ggbody</a></span><span class="op">(</span><span class="va">StatBoxplot</span><span class="op">$</span><span class="va">compute_panel</span>, inherit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Returning `ggbody(Stat$compute_panel)`</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; `{`</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; if (empty(data)) return(new_data_frame())</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; groups &lt;- split(data, data$group)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; stats &lt;- lapply(groups, function(group) {</span>
<span class="co">#&gt;     self$compute_group(data = group, scales = scales, ...)</span>
<span class="co">#&gt; })</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[5]]</span>
<span class="co">#&gt; stats &lt;- mapply(function(new, old) {</span>
<span class="co">#&gt;     if (empty(new)) </span>
<span class="co">#&gt;         return(new_data_frame())</span>
<span class="co">#&gt;     unique &lt;- uniquecols(old)</span>
<span class="co">#&gt;     missing &lt;- !(names(unique) %in% names(new))</span>
<span class="co">#&gt;     cbind(new, unique[rep(1, nrow(new)), missing, drop = FALSE])</span>
<span class="co">#&gt; }, stats, groups, SIMPLIFY = FALSE)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[6]]</span>
<span class="co">#&gt; rbind_dfs(stats)</span></code></pre></div>
</div>
<div id="step-3-ggtrace---retrieve-the-parent-environment" class="section level3">
<h3 class="hasAnchor">
<a href="#step-3-ggtrace---retrieve-the-parent-environment" class="anchor"></a><strong>Step 3. <code>ggtrace()</code> - retrieve the parent environment</strong>
</h3>
<p><code>Stat$compute_panel</code> does split-apply-combine (Steps 3, 4-5, 6).</p>
<p>Let‚Äôs return the split and the combine:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/ggtrace.html">ggtrace</a></span><span class="op">(</span>
  <span class="va">Stat</span><span class="op">$</span><span class="va">compute_panel</span>,
  trace_steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">6</span><span class="op">)</span>,
  trace_exprs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span><span class="op">(</span><span class="op">~</span><span class="va">step</span><span class="op">)</span>,         <span class="co"># What are the splits?</span>
    <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span><span class="op">(</span><span class="op">~</span><span class="va">step</span><span class="op">)</span>,         <span class="co"># What does the combined result look like?</span>
    <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Grab the method environment</span>
  <span class="op">)</span>,
  .print <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="co">#&gt; Stat$compute_panel now being traced</span>

<span class="co"># plot not printed to save space</span>
<span class="va">boxplot_plot</span>
<span class="co">#&gt; Triggering trace on Stat$compute_panel </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 3]&gt; groups &lt;- split(data, data$group) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 6]&gt; rbind_dfs(stats) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 6]&gt; environment() </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call `last_ggtrace()` to get the trace dump.</span>
<span class="co">#&gt; Untracing Stat$compute_panel</span></code></pre></div>
</div>
<div id="step-4-inspect-trace-dump-2" class="section level3">
<h3 class="hasAnchor">
<a href="#step-4-inspect-trace-dump-2" class="anchor"></a><strong>Step 4. Inspect trace dump</strong>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">boxplot_tracedump</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/last_ggtrace.html">last_ggtrace</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># The splits</span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">boxplot_tracedump</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">nrow</span><span class="op">)</span>
<span class="co">#&gt;   1   2   3   4   5 </span>
<span class="co">#&gt;  26  51 127 144 152</span>

<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">boxplot_tracedump</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">head</span>, <span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt; $`1`</span>
<span class="co">#&gt;    x    y PANEL group</span>
<span class="co">#&gt; 9  1 65.1     1     1</span>
<span class="co">#&gt; 92 1 55.1     1     1</span>
<span class="co">#&gt; 98 1 66.3     1     1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`2`</span>
<span class="co">#&gt;    x    y PANEL group</span>
<span class="co">#&gt; 3  2 56.9     1     2</span>
<span class="co">#&gt; 5  2 63.3     1     2</span>
<span class="co">#&gt; 11 2 64.0     1     2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`3`</span>
<span class="co">#&gt;   x    y PANEL group</span>
<span class="co">#&gt; 6 3 62.8     1     3</span>
<span class="co">#&gt; 7 3 62.3     1     3</span>
<span class="co">#&gt; 8 3 61.9     1     3</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`4`</span>
<span class="co">#&gt;    x    y PANEL group</span>
<span class="co">#&gt; 2  4 59.8     1     4</span>
<span class="co">#&gt; 4  4 62.4     1     4</span>
<span class="co">#&gt; 13 4 60.4     1     4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`5`</span>
<span class="co">#&gt;    x    y PANEL group</span>
<span class="co">#&gt; 1  5 61.5     1     5</span>
<span class="co">#&gt; 12 5 62.8     1     5</span>
<span class="co">#&gt; 14 5 62.2     1     5</span>

<span class="co"># Manually calculating some boxplot parameters</span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">boxplot_tracedump</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">group</span><span class="op">$</span><span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; $`1`</span>
<span class="co">#&gt;     0%    25%    50%    75%   100% </span>
<span class="co">#&gt; 53.100 58.850 64.800 65.775 68.100 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`2`</span>
<span class="co">#&gt;    0%   25%   50%   75%  100% </span>
<span class="co">#&gt; 56.90 60.20 63.30 63.95 65.20 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`3`</span>
<span class="co">#&gt;   0%  25%  50%  75% 100% </span>
<span class="co">#&gt; 57.5 60.7 62.0 63.1 64.0 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`4`</span>
<span class="co">#&gt;     0%    25%    50%    75%   100% </span>
<span class="co">#&gt; 58.000 60.700 61.500 62.325 63.000 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`5`</span>
<span class="co">#&gt;    0%   25%   50%   75%  100% </span>
<span class="co">#&gt; 58.80 61.30 61.75 62.20 62.90</span>

<span class="co"># The combined result</span>
<span class="va">boxplot_tracedump</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt;   ymin lower middle  upper ymax               outliers notchupper notchlower x</span>
<span class="co">#&gt; 1 53.1 58.85  64.80 65.775 68.1                          66.94580   62.65420 1</span>
<span class="co">#&gt; 2 56.9 60.20  63.30 63.950 65.2                          64.12967   62.47033 2</span>
<span class="co">#&gt; 3 57.5 60.70  62.00 63.100 64.0                          62.33649   61.66351 3</span>
<span class="co">#&gt; 4 58.3 60.70  61.50 62.325 63.0 58.0, 58.0, 58.2, 58.0   61.71396   61.28604 4</span>
<span class="co">#&gt; 5 60.1 61.30  61.75 62.200 62.9       58.8, 59.9, 59.9   61.86534   61.63466 5</span>
<span class="co">#&gt;   width relvarwidth flipped_aes PANEL group</span>
<span class="co">#&gt; 1  0.75    5.099020       FALSE     1     1</span>
<span class="co">#&gt; 2  0.75    7.141428       FALSE     1     2</span>
<span class="co">#&gt; 3  0.75   11.269428       FALSE     1     3</span>
<span class="co">#&gt; 4  0.75   12.000000       FALSE     1     4</span>
<span class="co">#&gt; 5  0.75   12.328828       FALSE     1     5</span></code></pre></div>
<p>Using the returned environment opens up more powerful manipulations:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># What was inside the method environment?</span>
<span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span>envir <span class="op">=</span> <span class="va">boxplot_tracedump</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; [1] "data"   "groups" "scales" "self"   "stats"</span>

<span class="co"># Evaluate the expression in Step 6 with the method's runtime environment</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span>
  <span class="fu"><a href="reference/ggbody.html">ggbody</a></span><span class="op">(</span><span class="va">Stat</span><span class="op">$</span><span class="va">compute_panel</span><span class="op">)</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span>,
  envir <span class="op">=</span> <span class="va">boxplot_tracedump</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>
<span class="op">)</span>
<span class="co">#&gt;   ymin lower middle  upper ymax               outliers notchupper notchlower x</span>
<span class="co">#&gt; 1 53.1 58.85  64.80 65.775 68.1                          66.94580   62.65420 1</span>
<span class="co">#&gt; 2 56.9 60.20  63.30 63.950 65.2                          64.12967   62.47033 2</span>
<span class="co">#&gt; 3 57.5 60.70  62.00 63.100 64.0                          62.33649   61.66351 3</span>
<span class="co">#&gt; 4 58.3 60.70  61.50 62.325 63.0 58.0, 58.0, 58.2, 58.0   61.71396   61.28604 4</span>
<span class="co">#&gt; 5 60.1 61.30  61.75 62.200 62.9       58.8, 59.9, 59.9   61.86534   61.63466 5</span>
<span class="co">#&gt;   width relvarwidth flipped_aes PANEL group</span>
<span class="co">#&gt; 1  0.75    5.099020       FALSE     1     1</span>
<span class="co">#&gt; 2  0.75    7.141428       FALSE     1     2</span>
<span class="co">#&gt; 3  0.75   11.269428       FALSE     1     3</span>
<span class="co">#&gt; 4  0.75   12.000000       FALSE     1     4</span>
<span class="co">#&gt; 5  0.75   12.328828       FALSE     1     5</span>

<span class="co"># Manually call the compute_group method from StatBoxplot to apply</span>
<span class="co"># transformation to the first group using the method environment</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span><span class="op">(</span><span class="va">StatBoxplot</span><span class="op">$</span><span class="fu">compute_group</span><span class="op">(</span><span class="va">groups</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">scales</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span>,
  envir <span class="op">=</span> <span class="va">boxplot_tracedump</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>
<span class="op">)</span>
<span class="co">#&gt;   ymin lower middle  upper ymax outliers notchupper notchlower x width</span>
<span class="co">#&gt; 1 53.1 58.85   64.8 65.775 68.1             66.9458    62.6542 1  0.75</span>
<span class="co">#&gt;   relvarwidth flipped_aes</span>
<span class="co">#&gt; 1     5.09902       FALSE</span></code></pre></div>
</div>
</div>
<div id="example-4---compute_group-method-from-statsina-ggforce" class="section level2">
<h2 class="hasAnchor">
<a href="#example-4---compute_group-method-from-statsina-ggforce" class="anchor"></a><strong>Example 4 - <code>compute_group</code> method from <code>StatSina</code> {ggforce}</strong>
</h2>
<div id="step-1-make-plot-3" class="section level3">
<h3 class="hasAnchor">
<a href="#step-1-make-plot-3" class="anchor"></a><strong>Step 1. Make plot</strong>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggforce.data-imaginist.com">ggforce</a></span><span class="op">)</span> <span class="co"># v.0.3.3</span>

<span class="va">sina_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="va">diamonds</span><span class="op">$</span><span class="va">cut</span> <span class="op">==</span> <span class="st">"Ideal"</span>,<span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,<span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">cut</span>, <span class="va">depth</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggforce.data-imaginist.com/reference/geom_sina.html">geom_sina</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">2021</span><span class="op">)</span>
<span class="va">sina_plot</span></code></pre></div>
<p><img src="reference/figures/README-ex-4-setup-1.png" width="100%"></p>
</div>
<div id="step-2-inspect-body-of-the-ggproto-method-3" class="section level3">
<h3 class="hasAnchor">
<a href="#step-2-inspect-body-of-the-ggproto-method-3" class="anchor"></a><strong>Step 2. Inspect body of the ggproto method</strong>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/ggbody.html">ggbody</a></span><span class="op">(</span><span class="va">StatSina</span><span class="op">$</span><span class="va">compute_group</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; `{`</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; if (nrow(data) == 0) return(NULL)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; if (nrow(data) &lt; 3) {</span>
<span class="co">#&gt;     data$density &lt;- 0</span>
<span class="co">#&gt;     data$scaled &lt;- 1</span>
<span class="co">#&gt; } else if (method == "density") {</span>
<span class="co">#&gt;     range &lt;- range(data$y, na.rm = TRUE)</span>
<span class="co">#&gt;     bw &lt;- calc_bw(data$y, bw)</span>
<span class="co">#&gt;     dens &lt;- compute_density(data$y, data$w, from = range[1], </span>
<span class="co">#&gt;         to = range[2], bw = bw, adjust = adjust, kernel = kernel)</span>
<span class="co">#&gt;     densf &lt;- stats::approxfun(dens$x, dens$density, rule = 2)</span>
<span class="co">#&gt;     data$density &lt;- densf(data$y)</span>
<span class="co">#&gt;     data$scaled &lt;- data$density/max(dens$density)</span>
<span class="co">#&gt;     data</span>
<span class="co">#&gt; } else {</span>
<span class="co">#&gt;     bin_index &lt;- cut(data$y, bins, include.lowest = TRUE, labels = FALSE)</span>
<span class="co">#&gt;     data$density &lt;- tapply(bin_index, bin_index, length)[as.character(bin_index)]</span>
<span class="co">#&gt;     data$density[data$density &lt;= bin_limit] &lt;- 0</span>
<span class="co">#&gt;     data$scaled &lt;- data$density/max(data$density)</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; if (length(unique(data$x)) &gt; 1) {</span>
<span class="co">#&gt;     width &lt;- diff(range(data$x)) * maxwidth</span>
<span class="co">#&gt; } else {</span>
<span class="co">#&gt;     width &lt;- maxwidth</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[5]]</span>
<span class="co">#&gt; data$width &lt;- width</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[6]]</span>
<span class="co">#&gt; data$n &lt;- nrow(data)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[7]]</span>
<span class="co">#&gt; data$x &lt;- mean(range(data$x))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[8]]</span>
<span class="co">#&gt; data</span></code></pre></div>
</div>
<div id="step-3-ggtrace---inject-code-that-modifies-method-env" class="section level3">
<h3 class="hasAnchor">
<a href="#step-3-ggtrace---inject-code-that-modifies-method-env" class="anchor"></a><strong>Step 3. <code>ggtrace()</code> - inject code that modifies method env</strong>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/ggtrace.html">ggtrace</a></span><span class="op">(</span>
  method <span class="op">=</span> <span class="va">StatSina</span><span class="op">$</span><span class="va">compute_group</span>,
  trace_steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span>,
  trace_exprs <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">exprs</a></span><span class="op">(</span>
    <span class="va">data</span>, <span class="co"># 1. What does the data passed in look like at the start?</span>
    <span class="co"># 2. Modify data in-place in the method environment</span>
    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      <span class="va">data</span>,         
      y <span class="op">=</span> <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span>,    <span class="co"># Shift the points up</span>
      x <span class="op">=</span> <span class="va">x</span> <span class="op">-</span> <span class="fl">.2</span>    <span class="co"># Shift the points left</span>
    <span class="op">)</span>,
    <span class="va">data</span> <span class="co"># 3. What do the stat transformations on the</span>
         <span class="co">#    _manipulated_ data look like at the end?</span>
  <span class="op">)</span>,
  .print <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="co">#&gt; StatSina$compute_group now being traced</span>

<span class="va">sina_plot</span>
<span class="co">#&gt; Triggering trace on StatSina$compute_group </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 1]&gt; data </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 1]&gt; data &lt;- dplyr::mutate(data, y = y + 1, x = x - 0.2) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [Step 8]&gt; data </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call `last_ggtrace()` to get the trace dump.</span>
<span class="co">#&gt; Untracing StatSina$compute_group</span></code></pre></div>
<p><img src="reference/figures/README-ex-4-ggtrace-1.png" width="100%"></p>
<p>This effect is ephemeral with the <code>once = TRUE</code> default in <code><a href="reference/ggtrace.html">ggtrace()</a></code>, meaning that only this last plot is built with the modifications.</p>
<p>Here we confirm that the method is restored on exit:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sina_plot</span></code></pre></div>
<p><img src="reference/figures/README-ex-4-ggtrace-restored-1.png" width="100%"></p>
</div>
<div id="step-4-inspect-trace-dump-3" class="section level3">
<h3 class="hasAnchor">
<a href="#step-4-inspect-trace-dump-3" class="anchor"></a><strong>Step 4. Inspect trace dump</strong>
</h3>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sina_tracedump</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/last_ggtrace.html">last_ggtrace</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># StatSina did calculations on the modified data in the last `ggtrace()`</span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">sina_tracedump</span>, <span class="va">head</span>, <span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt; $`[Step 1]&gt; data`</span>
<span class="co">#&gt;   x    y PANEL group</span>
<span class="co">#&gt; 1 1 61.5     1     1</span>
<span class="co">#&gt; 2 1 62.8     1     1</span>
<span class="co">#&gt; 3 1 62.2     1     1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`[Step 1]&gt; data &lt;- dplyr::mutate(data, y = y + 1, x = x - 0.2)`</span>
<span class="co">#&gt;     x    y PANEL group</span>
<span class="co">#&gt; 1 0.8 62.5     1     1</span>
<span class="co">#&gt; 2 0.8 63.8     1     1</span>
<span class="co">#&gt; 3 0.8 63.2     1     1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`[Step 8]&gt; data`</span>
<span class="co">#&gt;     x    y PANEL group   density    scaled width  n</span>
<span class="co">#&gt; 1 0.8 62.5     1     1 0.4632389 0.8454705   0.9 50</span>
<span class="co">#&gt; 2 0.8 63.8     1     1 0.2134967 0.3896590   0.9 50</span>
<span class="co">#&gt; 3 0.8 63.2     1     1 0.4973098 0.9076543   0.9 50</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/yjunechoe/ggtrace/">https://‚Äãgithub.com/‚Äãyjunechoe/‚Äãggtrace/‚Äã</a>
</li>
<li>Report a bug at <br><a href="https://github.com/yjunechoe/ggtrace/issues">https://‚Äãgithub.com/‚Äãyjunechoe/‚Äãggtrace/‚Äãissues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>
<a href="https://yjunechoe.github.io">June Choe</a> <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-0701-921X" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by <a href="https://yjunechoe.github.io">June Choe</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
